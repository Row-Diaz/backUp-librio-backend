app.post("/pedidos/test", authenticateJWT, (req, res) => {
  console.log("Test endpoint llamado");
  res.status(200).json({ message: "Test OK", usuario: req.user.id_usuarios });
});

// Crear nuevo pedido con timeout
app.post('/pedidos', authenticateJWT, async (req, res) => {
  const timeoutId = setTimeout(() => {
    if (!res.headersSent) {
      res.status(408).json({ error: 'Timeout: operación tomó demasiado tiempo' });
    }
  }, 8000); // 8 segundos (antes del límite de Vercel de 10s)

  try {
    console.log('Creando pedido para usuario:', req.user.id_usuarios);
    const pedido = await crearPedido(req.user.id_usuarios, req.body.carrito);
    clearTimeout(timeoutId);
    if (!res.headersSent) {
      res.status(201).json({ message: 'Pedido creado exitosamente', pedido });
    }
  } catch (error) {
    clearTimeout(timeoutId);
    console.error('Error al crear pedido:', error.message);
    if (!res.headersSent) {
      res.status(400).json({ error: error.message });
    }
  }
});
